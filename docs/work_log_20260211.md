# 부산 지역 다중지역 지원 및 시각화 전면 개선
# Busan Multi-Region Support & Visualization Overhaul

**작업일**: 2026-02-11
**작업자**: Claude AI Assistant

---

## 목차

1. [부산 지역 암상 동적 분류 시스템](#1-부산-지역-암상-동적-분류-시스템)
2. [단면도 시각화 전면 개선](#2-단면도-시각화-전면-개선)
3. [경계위치도 가시성 강화](#3-경계위치도-가시성-강화)
4. [자동단면 품질 필터링](#4-자동단면-품질-필터링)
5. [대시보드 파일 경로 수정](#5-대시보드-파일-경로-수정)
6. [Review Report 대시보드 연동](#6-review-report-대시보드-연동)
7. [관입체 "수직벽" 문제 근본 해결](#7-관입체-수직벽-문제-근본-해결)
8. [출력 파일 정리 자동화](#8-출력-파일-정리-자동화)

---

## 1. 부산 지역 암상 동적 분류 시스템

### 1.1 문제

부산 shapefile의 17개 LITHOIDX 코드 중 Qa를 제외한 **16개 암상이 모두 분류 실패**.
`get_dip_for_litho_pair()`에 서울 지역 암상만 하드코딩되어 있었음.

```python
# 변경 전: 서울 전용 하드코딩
intrusive_rocks = {'Pgr', 'Jbgr', 'Kqp', 'Kqv', 'Kfl'}         # 서울만
metamorphic = {'PCEbngn', 'PCEggn', 'PCEls', 'PCEqz', 'PCEam'}  # 서울만
```

부산의 백악기 화산암/관입암(Kan, Kanb, Kbgr, Khgdi, Kga, Kgp, Krb, Krh, Krt, Krwt, Kts, Kdban, Kdlw, Kdtb, Kdup, Kad)이 모두 `None` → 55°/very_low 폴백.

### 1.2 추가 문제: 코드 불일치

Shapefile의 LITHOIDX 코드와 지식베이스(KB)의 ROCK_UNITS 코드가 상이:

| Shapefile (LITHOIDX) | KB (ROCK_UNITS) | 암석명 |
|---------------------|-----------------|--------|
| Kan | Ka | 안산암류 |
| Kanb | Kavb | 안산암질 화산각력암 |
| Kbgr | Kgr | 흑운모화강암 |
| Khgdi | Kgd | 각섬석화강섬록암 |
| Kga | Kgb | 반려암 |
| Kgp | Kp | 화강반암 |
| Krb | Krvb | 유문석영안산암질 화산각력암 |
| Krh | Kr | 유문암질암 |
| Krt | Krd | 유문암질 응회암 |
| Krwt | Krvb | 유문석영안산암질 용결응회암 |
| Kdban/Kdlw/Kdtb/Kdup | Kdd | 다대포층 (세부단위) |
| Kad | Kp | 산성암맥 |
| Qa | Qal | 충적층 |

### 1.3 해결: 4단계 우선순위 분류 체계

```
Priority 1: LLM 분석 결과 (정확한 경계 매칭 + KB 교차검증)
    ↓ 매칭 실패 또는 KB와 불일치
Priority 2: 지식베이스 ROCK_UNITS (LITHOIDX_TO_KB 매핑 경유)
    ↓ KB 미로드
Priority 3: 하드코딩 베이스 (서울 + 부산 누적)
    ↓ 어디에도 미등록
Priority 4: 제네릭 폴백 (55°, unknown, very_low)
```

### 1.4 수정 내역

**`DataRepository/BusanData/busan_geological_knowledge_auto.py`**:
- `LITHOIDX_TO_KB` 딕셔너리 추가 (17개 매핑)

**`apply_llm_results.py`**:
- 신규 함수 3개: `_load_kb_module()`, `_parse_dip_range()`, `_classify_pair_from_kb()`
- `get_dip_for_litho_pair()` 전면 재구성 (4단계 우선순위)
- 하드코딩 베이스에 부산 암상 추가 (관입 9종, 정합화산암 7종)

### 1.5 검증

| 암상 쌍 | 변경 전 | 변경 후 |
|---------|---------|---------|
| Kan + Kanb | 55° unknown | 25.0° conformable |
| Qa + Kan | 55° unknown | 12.5° unconformable |
| Kbgr + Kan | 55° unknown | 75.0° intrusive |
| Khgdi + Kts | 55° unknown | 75.0° intrusive |

**16/16 부산 암상 코드 정상 분류** (이전: 0/16)

---

## 2. 단면도 시각화 전면 개선

### 2.1 문제

- 암석체에 경계선(edge)이 없어 인접 암석과 구분 불가
- 암석 코드 라벨이 없어 어떤 암상인지 식별 불가
- 배경 기반암 색상(alpha=0.6)이 너무 진해 앞의 암석체를 가림

### 2.2 수정 (apply_llm_results.py)

```python
# 변경 전
ax1.fill(poly_x, poly_y, color=color, alpha=alpha,
         edgecolor='none', label=label, zorder=poly_zorder)

# 변경 후
ax1.fill(poly_x, poly_y, color=color, alpha=alpha,
         edgecolor='black', linewidth=0.8, label=label, zorder=poly_zorder)

# 암석 코드 라벨 추가 (폭이 충분한 바디에만)
if body_width > length * 0.02:
    ax1.text(label_x, label_y, litho_code, fontsize=7, fontweight='bold',
             ha='center', va='center', color='black',
             bbox=dict(boxstyle='round,pad=0.2', facecolor='white', alpha=0.7))
```

- 배경 기반암 alpha: 0.6 → 0.35

---

## 3. 경계위치도(Boundary Location Map) 가시성 강화

### 3.1 문제

- 단면선이 얇은 검은색(linewidth=2, alpha=0.7)으로 어두운 암상 위에서 안 보임
- 암상 범례(legend)가 없음
- 분석된 경계 위치에 어떤 암상이 접하는지 라벨 없음

### 3.2 수정 (apply_llm_results.py)

**단면선 가시성**:
```python
# 이중 라인: 흰색 배경(5px) + 검은색 전경(2.5px)
ax.plot(xs, ys, color='white', linewidth=5, solid_capstyle='round', zorder=6)
ax.plot(xs, ys, color='black', linewidth=2.5, solid_capstyle='round', zorder=7)

# 시작점(○), 끝점(□) 마커 추가
ax.plot(xs[0], ys[0], 'o', color='white', markersize=10, ...)
ax.plot(xs[-1], ys[-1], 's', color='white', markersize=10, ...)

# 노란색 라벨 박스
ax.annotate(name, xy=(mid_x, mid_y), fontsize=9, fontweight='bold',
            bbox=dict(boxstyle='round,pad=0.3', facecolor='yellow', alpha=0.9))
```

**암상 범례 추가**:
- 단면도에 표현된 모든 고유 LITHOIDX 코드별 색상 패치
- 하단 우측에 범례 배치

**접촉유형 범례 추가**:
- intrusive(빨강), unconformable(파랑), conformable(초록) 범례

**경계 라벨 추가**:
- 분석된 각 경계 위치에 인접 암상 코드 라벨 (예: "Qa-Kts", "Kanb")

---

## 4. 자동단면 품질 필터링

### 4.1 문제

Auto_A_A 단면이 주로 해양 영역을 횡단하여 완전 공백 (기반암만 표시).

### 4.2 수정 (cross_section_analysis.py)

```python
# 기존 30% 커버리지 필터에 추가
section_litho = data['litho'][data['litho'].intersects(clipped)]
litho_codes_on_line = set(section_litho['LITHOIDX'].dropna().unique())

if len(litho_codes_on_line) < 2:
    print(f"  Auto Section {i+1}: SKIPPED (only {len(litho_codes_on_line)} rock type(s), need ≥2)")
    continue
```

자동 생성 단면은 **2종 이상의 고유 암상**을 횡단해야 채택됨.

### 4.3 출력 정리 연동

필터링된 단면의 이전 PNG 잔존 방지:
```python
# 새 분석 시작 전 기존 *_llm_section.png 삭제
import glob as glob_mod
for old_png in glob_mod.glob(str(OUTPUT_DIR / '*_llm_section.png')):
    os.remove(old_png)
```

`review_agent_llm.py`가 `*_llm_section.png`을 glob으로 수집하므로, 필터링된 단면은 자동으로 검토 대상에서도 제외됨.

---

## 5. 대시보드 파일 경로 수정

### 5.1 문제

대시보드의 `toFileUrl()` 함수가 파일명만 추출하여 `/files/filename.html` 경로 생성.
서버의 `/files/` 엔드포인트가 `output/` 디렉토리를 서빙하므로, 부산 결과(`output/Busan/report.html`)가 아닌 루트의 서울 결과가 반환됨.

### 5.2 수정 (geology_agent/api/static/dashboard.html)

```javascript
// 변경 전
function toFileUrl(path) {
    const name = path.split(/[/\\]/).pop();
    return '/files/' + encodeURIComponent(name);
}

// 변경 후 - output/ 이하 서브디렉토리 경로 보존
function toFileUrl(path) {
    if (!path) return '';
    if (path.startsWith('/') || path.startsWith('http')) return path;
    const outputIdx = path.replace(/\\/g, '/').indexOf('/output/');
    if (outputIdx >= 0) {
        const relPath = path.replace(/\\/g, '/').substring(outputIdx + '/output/'.length);
        return '/files/' + relPath.split('/').map(encodeURIComponent).join('/');
    }
    const name = path.split(/[/\\]/).pop();
    return '/files/' + encodeURIComponent(name);
}
```

예: `D:\...\output\Busan\report.html` → `/files/Busan/report.html` (이전: `/files/report.html`)

---

## 6. Review Report 대시보드 연동

### 6.1 문제

`workflow.py`의 `review_node()`가 `html_report_path`를 state에 전달하지 않아, 대시보드에서 Review Report 링크가 null.

### 6.2 수정 (geology_agent/workflow.py)

```python
# review_results 딕셔너리에 html_report_path 추가
review_results = {
    "total_reviewed": result.get("total_reviewed", 0),
    "average_score": result.get("average_score", 0.0),
    "reviews": result.get("reviews", []),
    "critical_issues": result.get("critical_issues", []),
    "html_report_path": result.get("html_report_path"),  # 추가
}
```

---

## 7. 관입체 "수직벽" 문제 근본 해결

### 7.1 문제

검토 에이전트가 "관입체들은 수직벽으로 표현됨"이라고 반복 지적.

**근본 원인 3가지**:

1. **LLM Partial Match Override**: 코드 라인 299-307에서 LLM 경계의 `adjacent_lithologies`에 하나라도 매칭되면 LLM의 경사각(75°)을 사용. KB의 정밀한 값(25°)을 덮어씀.

2. **LLM 다중 암상 경계 오분류**: LLM이 [Qa, Kts, Kan]을 하나의 "intrusive 75°" 경계로 그룹화. 이 결과 Qa-Kan (실제: unconformable 12.5°)도 75°로 적용됨.

3. **`generate_intrusion_boundary()` 파라미터 무시**: 함수가 전달받은 `base_dip` 파라미터를 무시하고 항상 고정 `surface_dip=35`를 사용.

### 7.2 수정 (apply_llm_results.py)

**수정 1: Partial Match 제거**
```python
# 삭제된 코드 (이전 라인 299-307)
# for boundary in llm_results['boundaries']:
#     lithos = boundary.get('adjacent_lithologies', [])
#     if litho1 in lithos or litho2 in lithos:  # OR 매칭 → 과도한 적용
#         return extract_full_info(boundary)
```

**수정 2: Priority 1에 KB 교차검증 추가**
```python
# Priority 2 (KB)를 먼저 계산하여 교차검증 기준으로 사용
expected_type, kb_dip = _classify_pair_from_kb(litho1, litho2)

# Priority 1: LLM 정확 매칭 + KB 교차검증
for boundary in llm_results['boundaries']:
    lithos = boundary.get('adjacent_lithologies', [])
    if litho1 in lithos and litho2 in lithos:  # AND 매칭 (정확)
        llm_type = boundary.get('contact_type', 'unknown')
        if expected_type is None or llm_type == expected_type:
            return extract_full_info(boundary)
        break  # LLM/KB 불일치 → KB 우선
```

**수정 3: `generate_intrusion_boundary()` 동적 경사**
```python
# 변경 전
surface_dip = 35  # 고정값

# 변경 후 - base_dip 파라미터 활용
surface_dip = max(25, min(50, abs(base_dip))) if base_dip else 35
mid_dip = surface_dip * 0.5
bottom_dip = max(5, surface_dip * 0.15)
```

### 7.3 검증 결과

| 암상 쌍 | 변경 전 | 변경 후 |
|---------|---------|---------|
| Qa-Kan | 75° intrusive | 12.5° unconformable |
| Kanb-Kan | 75° intrusive (partial match) | 25° conformable |
| Khgdi-Kan | 75° intrusive | 75° intrusive (정상) |
| 하부 바닥 경사 (Kanb, Qa, Kan) | 69-71° | 4° |

---

## 8. 출력 파일 정리 자동화

### 8.1 분석 시작 전 정리

`apply_llm_results.py`와 `geology_agent/tools/visualization.py` 양쪽에 추가:

```python
# 이전 실행의 단면도 PNG 삭제 (필터링된 단면의 잔존 파일 방지)
import glob as glob_mod
for old_png in glob_mod.glob(str(OUTPUT_DIR / '*_llm_section.png')):
    os.remove(old_png)
```

### 8.2 output/ 루트 정리

이전 서울 분석의 결과물이 `output/` 루트에 남아 대시보드를 혼란시키는 문제 해결. `output/{Region}/` 하위 디렉토리로만 결과 저장되도록 정리.

---

## 9. 수정된 파일 전체 목록

| 파일 | 주요 변경 |
|------|----------|
| `apply_llm_results.py` | 4단계 분류체계, 시각화 개선, 경계위치도 범례, 관입체 동적 경사, 출력 정리 |
| `cross_section_analysis.py` | 암상 다양성 필터 (≥2종), 커버리지 필터 |
| `geology_agent/workflow.py` | review_node에 html_report_path 전달 |
| `geology_agent/tools/visualization.py` | 출력 정리 로직 추가 |
| `geology_agent/api/static/dashboard.html` | toFileUrl() 서브디렉토리 경로 보존 |
| `DataRepository/BusanData/busan_geological_knowledge_auto.py` | LITHOIDX_TO_KB 매핑 추가 |

---

## 10. 부산 최종 결과

### 생성된 단면도

- `AA_BUSAN_llm_section.png` - AA' 단면 (공식 단면선)
- `Auto_B_B_llm_section.png` - 자동 단면 B-B'
- `Auto_C_C_llm_section.png` - 자동 단면 C-C'
- (Auto_A_A: 해양 영역 위주로 필터링됨)

### 접촉유형 분포

| 접촉유형 | 건수 | 비고 |
|---------|------|------|
| intrusive | 2 | Khgdi-Kan 등 화강암 관입 |
| unconformable | 1 | Qa-Kan 부정합 |
| conformable | 1 | Kanb-Kan 정합 |
| unknown/very_low | 0 | (이전: 대부분) |

---

**작업 완료**: 2026-02-11 22:00
